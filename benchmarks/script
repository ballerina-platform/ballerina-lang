#!/usr/bin/env bash

set -e

export BAL_HOME=$1
chmod +x ${BAL_HOME}/bin/ballerina
export PATH=${BAL_HOME}/bin:$PATH
export resultsFolderName=results

echo "Running Performance benchmarks ..."

if [ ! -d "$resultsFolderName" ]; then
 mkdir ${resultsFolderName}
fi

echo "Function_Name,Total Time (ms),Average Latency (ns),Throughput (operations/second),GC throughput (%),freedMemoryByFullGC (M),maxPause (s), " > ${resultsFolderName}/$4.csv

ballerina build benchmark

for word in $(<benchmarkFunctions.txt)
do
 export _JAVA_OPTIONS="-Xloggc:"$5gc_${word}.log""
 ballerina run target/benchmark.balx $2 $3 ${word} | tr -d "\n" >> ${resultsFolderName}/$4.csv
 unset _JAVA_OPTIONS
 java -jar target/gcviewer-$6.jar target/gc_${word}.log target/gc_summarry_${word}.csv
 awk -F "\"*;\"*" '{print $2}' target/gc_summarry_${word}.csv | awk NR==37 | tr -d "\n"   >>  ${resultsFolderName}/$4.csv
 echo "," | tr -d "\n" >> ${resultsFolderName}/$4.csv
 awk -F "\"*;\"*" '{print $2}' target/gc_summarry_${word}.csv | awk NR==5 | tr -d "\n"  >>  ${resultsFolderName}/$4.csv
 echo "," | tr -d "\n" >> ${resultsFolderName}/$4.csv
 awk -F "\"*;\"*" '{print $2}' target/gc_summarry_${word}.csv | awk NR==24   >>  ${resultsFolderName}/$4.csv
done
